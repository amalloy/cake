#!/usr/bin/env bash
# Save your fork, there's cake!"

function bake {
  java -cp "$CLASSPATH" clojure.main -e "(use 'cake)(-main)" /dev/null $@
}

FILE="$(readlink $0)"
FILE=${FILE:-$0}
CAKE="$(dirname "$(dirname "$FILE")")"
CLASSPATH="$CAKE/src/:$CAKE/lib/*"

JAR="http://github.com/downloads/ninjudd/cake-standalone/cake-standalone.jar"

if [ "$(which curl)" == "" ]; then
  GET="wget -qO"
else
  GET="curl -Lso"
fi

# Bootstap cake deps
if [ ! -e "$CAKE/.deps" ]; then
  echo "fetching cake dependencies..."
  rm -rf $CAKE/lib
  mkdir -p $CAKE/lib
  $GET $CAKE/lib/$(basename $JAR) $JAR || exit
  touch "$CAKE/.deps"
fi

if [ "project.clj" -nt "pom.xml" ] && [ "$1" != "deps" ]; then
  bake deps
fi

bake $@